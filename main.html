<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tax Assistant</title>
    <style>
      .message {
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 8px;
    background: var(--background-light);
}

.message.user {
    background: #e3f2fd;
    margin-left: 2rem;
}

.message.assistant {
    background: #f0f4c3;
    margin-right: 2rem;
}

.message .role {
    font-weight: bold;
    color: var(--primary-blue);
    margin-bottom: 0.5rem;
}

.message .content {
    line-height: 1.6;
}

        :root {
            --primary-blue: #2563eb;
            --secondary-blue: #3b82f6;
            --accent-orange: #f59e0b;
            --background-light: #f8fafc;
            --text-dark: #1e293b;
        }
.explain-btn {
    background: var(--accent-orange);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0.4rem 0.8rem;
    margin-left: 0.5rem;
    cursor: pointer;
    transition: transform 0.2s;
}

.deduction-help {
    background: #f0f8ff;  
    border-left: 6px solid #ff9800;
    margin-top: 5rem;
    padding: 5rem;
    
}
.technical-details {
    background: #e6f4ff;  /* Slightly darker blue */
    border-left: 3px solid #eec81e;
}

.calculation-example {
    background: #ffe0e0;
    border-left: 2px solid #f7d40f;
}


.response-box{
    background: var(--background-light);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-blue);
        }

.calculation-example {
    margin-top: 1rem;
    padding: 1rem;
    background: #577aaf;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #f8fafc 100%);
            padding: 2rem;
            color: var(--text-dark);
        }

        .container {
            background: rgba(255, 255, 255, 0);
            max-width: 500px;
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition:0.2s;
        }

        .container:hover {
            transform: translateY(-2px);
        }

        h2 {
            color: var(--primary-blue);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-orange);
            display: inline-block;
        }

        .input-group {
            margin: 1.5rem 0;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        button {
            background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue));
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .response-box {
            background: var(--background-light);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--primary-blue);
        }

        .ai-analysis {
            background: #e0fffc;
            border-left: 4px solid #ff9800;
            margin-top: 1rem;
            padding: 1rem;
        }

        .loading {
            color: #64748b;
            font-style: italic;
        }

.toggle-button {
    background: #f0f4ff;
    color: #1e40af;  /* Added dark blue text color */
    border: none;
    padding: 0.5rem 1rem;
    margin-top: 1rem;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.3s;
}
    .deduction-help {
    margin-top: 0.8rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid var(--primary-blue);
    color: var(--text-dark);
    line-height: 1.6;
}

.message {
    margin: 1rem 0;
    padding: 1rem;
    border-radius: 8px;
    background: var(--background-light);
}

.message.user {
    background: #e3f2fd;
    margin-left: 2rem;
}

.message.assistant {
    background: #f0f4c3;
    margin-right: 2rem;
}

.message .role {
    font-weight: bold;
    color: var(--primary-blue);
    margin-bottom: 0.5rem;
}

.message .content {
    line-height: 1.6;
}
/* General Styles */
body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    color: #333;
    line-height: 1.6;
}

.container {
    width: 90%;
    max-width: 1200px;
    margin: 0 auto;
}

/* Hero Section */
.hero {
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: white;
    padding: 100px 0;
    text-align: center;
}

.hero h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.hero p {
    font-size: 1.2rem;
    margin-bottom: 2rem;
}

.hero button {
    background: white;
    color: #2563eb;
    border: none;
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 5px;
    cursor: pointer;
}

/* Features Section */
.features {
    padding: 80px 0;
    background: #f8fafc;
}

.features h2 {
    text-align: center;
    margin-bottom: 2rem;
    font-size: 2rem;
}

.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.feature {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-align: center;
}

.feature h3 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

/* Chat Widget */
.chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: none;
}

.chat-header {
    background: #2563eb;
    color: white;
    padding: 10px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header button {
    background: none;
    border: none;
    color: rgb(12, 12, 12);
    font-size: 1.5rem;
    cursor: pointer;
}

.chat-messages {
    height: 300px;
    overflow-y: auto;
    padding: 10px;
}

.chat-input {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
}

.chat-input input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-right: 10px;
}

.chat-input button {
    background: #2563eb;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

/* Footer */
footer {
    background: #1e293b;
    color: rgb(250, 248, 248);
    padding: 20px 0;
    text-align: center;
}

footer nav a {
    color: rgb(253, 252, 252);
    margin: 0 10px;
    text-decoration: none;
}
    
    </style>
</head>
<body>

<div class="container">
    <h2>ü§ñ APNA CA AI Assistant</h2>
    <div class="chat-box" id="chatBox"></div>
    <div class="input-group">
        <textarea id="userInput" rows="3" placeholder="Ask about Indian tax laws..."></textarea>
    </div>
    <button onclick="askChatbot()">Get Answer</button>
    <div id="chatResponse" class="response-box"></div>
</div>

<script>
    const SESSION_ID = "user123"; // Use a unique identifier per user
    const API_KEY = "";
    const BACKEND_URL = "http://localhost:5000/chat"; // Your backend URL

    let chatHistory = JSON.parse(localStorage.getItem("taxChatHistory")) || [];

    function displayConversation() {
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = chatHistory.map(msg => `
            <div class="message ${msg.role}">
                <strong>${msg.role === 'user' ? 'üë§ You' : 'ü§ñ CA Assistant'}</strong>
                <p>${msg.content}</p>
            </div>
        `).join("");
        chatBox.scrollTop = chatBox.scrollHeight; // Auto-scroll
    }

    async function askChatbot() {
        const inputField = document.getElementById('userInput');
        const question = inputField.value.trim();
        if (!question) return;

        chatHistory.push({ role: 'user', content: question });
        inputField.value = "";
        displayConversation();

        try {
            document.getElementById('chatBox').innerHTML += '<p class="loading">Thinking...</p>';

            // Fetch AI response
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [{ role: "system", content: "You are a chartered accountant specializing in Indian tax laws. Provide clear, structured explanations with real-world examples." }, ...chatHistory.slice(-4)], // Keep recent messages

                    temperature: 0.5,
                    max_tokens: 1000
                })
            });

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            chatHistory.push({ role: 'assistant', content: aiResponse });

            // Chat Widget Functions
function openChat() {
    document.getElementById('chatWidget').style.display = 'block';
}

function closeChat() {
    document.getElementById('chatWidget').style.display = 'none';
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML += `<div class="message user">üë§ ${message}</div>`;
    input.value = '';

    // Call your chatbot API
    const response = await askChatbot(message);
    chatMessages.innerHTML += `<div class="message assistant">ü§ñ ${response}</div>`;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

            // Save to backend
            await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId: SESSION_ID, message: { role: "assistant", content: aiResponse } })
            });

            localStorage.setItem("taxChatHistory", JSON.stringify(chatHistory.slice(-50))); // Store latest 50 messages
            displayConversation();
        } catch (error) {
            console.error("Chatbot Error:", error);
            chatHistory.push({ role: 'assistant', content: "Sorry, an error occurred. Try again later." });
            displayConversation();
        }
    }

    async function loadChatHistory() {
        try {
            const response = await fetch(`${BACKEND_URL}/${SESSION_ID}`);
            const messages = await response.json();
            chatHistory = messages;
            displayConversation();
        } catch (error) {
            console.warn("Could not load chat history from backend.");
        }
    }

    window.addEventListener('load', loadChatHistory);
</script>
<section class="features">
    <div class="container">
        <h2>Key Features</h2>
        <div class="feature-grid">
            <div class="feature">
                <h3>Tax Calculations</h3>
                <p>Accurate tax calculations for both old and new regimes.</p>
            </div>
            <div class="feature">
                <h3>Fraud Detection</h3>
                <p>Identify potential fraud risks with AI analysis.</p>
            </div>
            <div class="feature">
                <h3>AI-Powered Insights</h3>
                <p>Get detailed explanations for complex tax scenarios.</p>
            </div>
        </div>
    </div>
</section>

<!-- Chat Widget -->
<div id="chatWidget" class="chat-widget">
    <div class="chat-header">
        <h3>TaxGPT</h3>
        <button onclick="closeChat()">√ó</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Ask a tax question...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<!-- tax Calculator Section( need changes asap) --> 
<div class="container">
    <h2>üßÆ Tax Calculator</h2>
    <div class="input-group">
        <label for="income">Annual Income (‚Çπ)
            <button class="explain-btn" onclick="explainSection('income')">Explain</button>
        </label>
        <input type="number" id="income" placeholder="Gross annual income">
        <div id="incomeHelp" class="deduction-help"></div>
    </div>

    <div class="input-group">
        <label for="deduction80C">Section 80C Deductions (‚Çπ)
            <button class="explain-btn" onclick="explainSection('80C')">Explain</button>
        </label>
        <input type="number" id="deduction80C" placeholder="EPF, PPF, insurance">
        <div id="80CHelp" class="deduction-help"></div>
    </div>

    <div class="input-group">
        <label for="hra">HRA Exemption (‚Çπ)
            <button class="explain-btn" onclick="explainSection('hra')">Explain</button>
        </label>
        <input type="number" id="hra" placeholder="House rent allowance">
        <div id="hraHelp" class="deduction-help"></div>
    </div>

    <div class="input-group">
        <label for="medical">Medical Insurance (‚Çπ)
            <button class="explain-btn" onclick="explainSection('medical')">Explain</button>
        </label>
        <input type="number" id="medical" placeholder="Section 80D deductions">
        <div id="medicalHelp" class="deduction-help"></div>

    </div>

    <div class="input-group">
        <label for="taxRegime">Tax Regime</label>
        <select id="taxRegime" aria-label="Tax regime">
            <option value="new">New Regime</option>
            <option value="old">Old Regime</option>
        </select>
    </div>
    <button onclick="calculateTax()">Calculate Tax</button>
    <div id="taxResult" class="response-box"></div>
</div>

<!-- Fraud Detection Section (still not update) -->
<div class="container">
    <h2>üîç Fraud Detection</h2>
    <div class="input-group">
        <label for="fraudIncome">Declared Income (‚Çπ)</label>
        <input type="number" id="fraudIncome" 
               placeholder="Reported income"
               aria-label="Declared income">
    </div>

    <div class="input-group">
        <label for="fraudTaxPaid">Tax Paid (‚Çπ)</label>
        <input type="number" id="fraudTaxPaid" 
               placeholder="Tax paid amount"
               aria-label="Tax paid">
    </div>

    <div class="input-group">
        <label for="fraudDeductions">Deductions (‚Çπ)</label>
        <input type="number" id="fraudDeductions" 
               placeholder="Total deductions"
               aria-label="Deductions claimed">
    </div>
    <button onclick="detectFraud()">Analyze Fraud Risk</button>
    <div id="fraudResult" class="response-box"></div>
</div>

<script>
    // WARNING: This frontend-only implementation exposes your API key
// Replace with backend implementation for production use
const OPENAI_API_KEY = ';

// Chat Widget Functions
function openChat() {
    document.getElementById('chatWidget').style.display = 'block';
}

function closeChat() {
    document.getElementById('chatWidget').style.display = 'none';
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML += `<div class="message user">üë§ ${message}</div>`;
    input.value = '';

    // Call your chatbot API
    const response = await askChatbot(message);
    chatMessages.innerHTML += `<div class="message assistant">ü§ñ ${response}</div>`;
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
// Enhanced AI explanation functions (need more prompt for correction)
const explanationPrompts = {
    'income': 'Explain taxable income calculation under Indian tax laws with examples including:',
    '80C': 'Detail Section 80C deductions with: 1. Eligible investments 2. Maximum limits 3. Documentation requirements',
    'hra': 'Explain HRA exemption calculation with: 1. Salary components 2. City classifications 3. Actual rent paid considerations',
    'medical': 'Describe medical insurance deductions under Section 80D including: 1. Age-based limits 2. Preventive health checkups 3. Senior citizen benefits'
};

async function explainSection(section) {
    const helpDiv = document.getElementById(`${section}Help`);

    // Debugging Log
    console.log(`üü° Fetching explanation for: ${section}`);

    try {
        helpDiv.innerHTML = '<div class="loading">Analyzing...</div>';

        // Fetch AI response and example separately
        const explanationPromise = getAIResponse(explanationPrompts[section]);
        const examplePromise = getAIResponse(`Create a numerical example for ${section} with step-by-step calculations.`);

        // ‚úÖ Wait for both, but if one fails, catch it
        let explanation = "Error fetching explanation.";
        let example = "Error fetching example.";

        try {
            explanation = await explanationPromise;
        } catch (ex) {
            console.error("‚ùå Failed to get explanation:", ex);
        }

        try {
            example = await examplePromise;
        } catch (ex) {
            console.error("‚ùå Failed to get example:", ex);
        }

        // Render content
        helpDiv.innerHTML = `
            <div class="technical-details">
                ${formatResponse(explanation)}
                <button class="toggle-button" onclick="toggleExample('${section}')">
                    Show Calculation Example ‚ñº
                </button>
                <div id="${section}Example" class="calculation-example" style="display:none">
                    ${formatResponse(example)}
                </div>
            </div>
        `;

    } catch (error) {
        console.error("‚ùå Error in explainSection():", error);
        helpDiv.innerHTML = 'Could not load explanation. Please try again later.';
    }
}

// Modified Chatbot Function with Memory ( backend issue onging)
async function askChatbot() {
    const questionInput = document.getElementById('userInput');
    const question = questionInput.value.trim();
    if (!question) return;

    // Add user question to history
    chatHistory.push({ role: 'user', content: question });
    questionInput.value = ''; // Clear input field

    // Display loading state
    const responseDiv = document.getElementById('chatResponse');
    responseDiv.innerHTML = '<div class="loading">Analyzing your question...</div>';

    try {
        // Prepare conversation context
        const messages = [
            { 
                role: "system", 
                content: `You are a Chartered Accountant with 20 years experience. Maintain context from previous conversations:
                ${JSON.stringify(chatHistory.slice(-4))} // Keep last 2 exchanges
                Current Indian Tax Year: 2024-25
                Respond in markdown with clear sections.`
            },
            { role: "user", content: question }
        ];

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: messages,
                temperature: 0.5,
                max_tokens: 1000
            })
        });

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;

        // Add AI response to history
        chatHistory.push({ role: 'assistant', content: aiResponse });

        // Persist to localStorage (max 50 messages)
        if(chatHistory.length > 50) chatHistory = chatHistory.slice(-50);
        localStorage.setItem('taxChatHistory', JSON.stringify(chatHistory));

        // Display formatted conversation
        displayConversation();

    } catch (error) {
        console.error("Chat Error:", error);
        responseDiv.innerHTML = '<div class="response-box">Error: Please try again later</div>';
    }
}

// Display full conversation history(issue)
function displayConversation() {
    const responseDiv = document.getElementById('chatResponse');
    responseDiv.innerHTML = chatHistory.map(msg => `
        <div class="message ${msg.role}">
            <div class="role">${msg.role === 'user' ? 'üë§ You' : 'ü§ñ CA Assistant'}</div>
            <div class="content">${formatResponse(msg.content)}</div>
        </div>
    `).join('');

    // Auto-scroll to bottom
    responseDiv.scrollTop = responseDiv.scrollHeight;
}

// Initial load of conversation history
window.addEventListener('load', () => {
    if(chatHistory.length > 0) displayConversation();
});
// ‚úÖ Enhanced API Call with Better Error Handling
async function getAIResponse(prompt) {
    console.log("üü° Sending API Request:", prompt);

    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [
                    { role: "system", content: "You are a chartered accountant specializing in Indian tax laws. Provide clear, structured explanations with real-world examples." },
                    { role: "user", content: prompt }
                ],
                temperature: 0.7,
                max_tokens: 1000
            })
        });

        console.log("üü° API Response Status:", response.status);

        if (!response.ok) {
            throw new Error(`‚ùå API Error: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        console.log("üü¢ API Response Data:", data);

        if (!data.choices || !data.choices[0] || !data.choices[0].message) {
            throw new Error("‚ùå Invalid API response format.");
        }

        return data.choices[0].message.content.trim();

    } catch (error) {
        console.error("‚ùå Error fetching AI response:", error);
        return "Error retrieving AI response.";
    }
}

// ‚úÖ Format response to HTML-safe output
function formatResponse(text) {
    return text.replace(/\n/g, '<br>'); // Preserve line breaks
}

function formatResponse(text) {
    return text
        .replace(/\n\n/g, '</p><p>')
        .replace(/(\d+\.)\s/g, '<br><strong>$1</strong> ')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
}

// Universal AI Query Function
async function askGPT(context, userData, targetId) {
    const targetElement = document.getElementById(targetId);
    targetElement.innerHTML = '<div class="loading">Analyzing with AI...</div>';

    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: [{
                    role: "system",
                    content: `Act as a Chartered Accountant (CA) with 20+ years of experience specializing in [Income Tax / GST / Corporate Tax / International Tax]. Provide a comprehensive explanation on [specific topic, e.g., deductions under Sectio. ${context}`
                },  {      
                    
                    role: "user",
                    content: userData
                    
                }],
                   temperature: 0.7,
                    max_tokens: 1000
                
            })      
            
        });

        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        
        targetElement.innerHTML = `
            <div class="ai-analysis">
                <h4>AI Analysis:</h4>
                <p>${aiResponse}</p>
                <button class="toggle-button" onclick="toggleDetails('${targetId}')">
                    Show Technical Details
                </button>
                <div id="${targetId}-details" style="display:none">
                    ${generateTechnicalDetails(context)}
                </div>
            </div>
        `;
    } catch (error) {
        targetElement.innerHTML = '<div class="response-box">Error in AI analysis</div>';
    }
}

// Tax Calculation with AI Explanation
async function calculateTax() {
    const income = parseFloat(document.getElementById('income').value) || 0;
    const deduction80C = parseFloat(document.getElementById('deduction80C').value) || 0;
    const hra = parseFloat(document.getElementById('hra').value) || 0;
    const medical = parseFloat(document.getElementById('medical').value) || 0;
    const regime = document.getElementById('taxRegime').value;

    let taxableIncome = income;
    if (regime === 'old') {
        taxableIncome -= (deduction80C + hra + medical);
    }

    let tax = 0;
    const slabs = regime === 'new' ? 
            [[1200000, 0], [1500000, 0.05], [2000000, 0.10], [2500000, 0.15], [3000000, 0.20], [Number.MAX_SAFE_INTEGER, 0.25]] :
            [[250000, 0], [500000, 0.05], [750000, 0.10], [1000000, 0.15], [1250000, 0.20], [1500000, 0.25], [Number.MAX_SAFE_INTEGER, 0.30]];


    for (let i = 1; i < slabs.length; i++) {
        const [prevLimit, prevRate] = slabs[i-1];
        const [currLimit, currRate] = slabs[i];
        if (taxableIncome > prevLimit) {
            tax += (Math.min(taxableIncome, currLimit) - prevLimit) * currRate;
        }
    }
 
    tax += tax * 0.04;
    
    const taxHtml = `
         <h3>Tax Liability: ‚Çπ${tax.toFixed(2)}</h3>
            <button onclick="askGPT(
                'Explain this tax calculation in simple terms. Include tax slabs, deductions, and final tax payable:',
                'Income: ‚Çπ${income}, Regime: ${regime}, Tax Payable: ‚Çπ${tax.toFixed(2)}',
                'taxResult'
            )">
                Get AI Explanation
            </button>
    `;
    document.getElementById('taxResult').innerHTML = taxHtml;
}

// Fraud Detection with AI Analysis
async function detectFraud() {
    const income = parseFloat(document.getElementById('fraudIncome').value) || 0;
    const taxPaid = parseFloat(document.getElementById('fraudTaxPaid').value) || 0;
    const deductions = parseFloat(document.getElementById('fraudDeductions').value) || 0;

    if (income <= 0) {
        alert("Income must be greater than zero.");
        return;
    }

    const taxableIncome = income - deductions;
    const reportedTaxRate = (taxPaid / income) * 100 || 0;
    const expectedTaxRate = calculateExpectedTaxRate(taxableIncome);
    const taxGap = expectedTaxRate - reportedTaxRate;

    let riskLevel = "Low";
    let riskReason = "Tax payment is within expected range.";

    if (reportedTaxRate < 5 || taxGap > 10) {
        riskLevel = "High";
        riskReason = "Significant underpayment of tax.";
    } else if (reportedTaxRate < 10 || taxGap > 5) {
        riskLevel = "Medium";
        riskReason = "Possible tax avoidance detected.";
    }

    // Generate Fraud Risk Result
    const fraudHtml = `
        <h3>Fraud Risk: ${riskLevel}</h3>
        <p>Reason: ${riskReason}</p>
        <p>Reported Tax Rate: ${reportedTaxRate.toFixed(2)}%</p>
        <p>Expected Tax Rate: ${expectedTaxRate.toFixed(2)}%</p>
        <button onclick="askGPT(
            'Analyze potential tax fraud patterns. Consider tax slabs, deductions, and evasion probability:',
            'Income: ‚Çπ${income}, Tax Paid: ‚Çπ${taxPaid}, Deductions: ‚Çπ${deductions}, Risk Level: ${riskLevel}',
            'fraudResult'
        )">
            Detailed AI Analysis
        </button>
    `;

    document.getElementById('fraudResult').innerHTML = fraudHtml;
}

// Helper function to calculate expected tax rate based on slabs
function calculateExpectedTaxRate(taxableIncome) {
    const slabs = [
        { limit: 250000, rate: 0 },
        { limit: 500000, rate: 5 },
        { limit: 1000000, rate: 10 },
        { limit: 2000000, rate: 15 },
        { limit: 5000000, rate: 20 },
        { limit: Number.MAX_SAFE_INTEGER, rate: 25 }
    ];

    let totalTax = 0;
    let previousLimit = 0;

    for (let slab of slabs) {
        if (taxableIncome > previousLimit) {
            let taxableAmount = Math.min(taxableIncome, slab.limit) - previousLimit;
            totalTax += taxableAmount * (slab.rate / 100);
        }
        previousLimit = slab.limit;
    }

    return (totalTax / taxableIncome) * 100 || 0;
}


// Chatbot Functionality
async function askChatbot() {
    const question = document.getElementById('userInput').value.trim();
    if (!question) return;

    askGPT('Answer concisely with relevant Indian tax laws and sections:', 
           question, 'chatResponse');
}

// Helper Functions
function toggleDetails(elementId) {
    const details = document.getElementById(`${elementId}-details`);
    details.style.display = details.style.display === 'none' ? 'block' : 'none';
}

function generateTechnicalDetails(context) {
    if (context.includes('tax calculation')) {
        return '<p>Technical breakdown based on Income Tax Act...</p>';
    }
    if (context.includes('fraud')) {
        return '<p>Fraud detection parameters and thresholds...</p>';
    }
    return '<p>Detailed technical analysis...</p>';
}
</script>

<!-- Footer(demo) -->
<footer>
    <div class="container">
        <p>&copy; 2024 APNA CA AI Assistant</p>
        <nav>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms of Service</a>
            <a href="#">Contact Us</a>
        </nav>
    </div>
</footer>

<script src="script.js"></script>
</body>

